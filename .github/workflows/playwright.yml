name: Playwright Tests

on:
  push:
    branches:
      - main
      - pwr-setup-scripts
  pull_request:

jobs:
  test:
    timeout-minutes: 30
    runs-on: windows-latest

    steps:
    - name: ⬇️ Checkout repository
      uses: actions/checkout@v4

    - name: 🧹 Run setup script
      shell: pwsh
      run: .\setup.ps1

    - name: 💾 Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: C:\Users\runneradmin\AppData\Local\ms-playwright
        key: playwright-browsers-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          playwright-browsers-${{ runner.os }}-

    - name: 📥 Install Playwright browsers
      run: npx playwright install --with-deps

    - name: 🚀 Start Angular dev server and wait
      shell: pwsh
      run: |
        $angular = Start-Process -FilePath "npm" -ArgumentList "start" -PassThru
        Start-Sleep -Seconds 5
        npx wait-on http://localhost:4200 --timeout=120000

    - name: 🧪 Run Playwright tests
      shell: pwsh
      run: npx playwright test --workers=4 --headed=false
